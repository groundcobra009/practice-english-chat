# データベース設計書

## 1. 概要

本設計書は、英語学習チャットシステム「practice-english-chat」のSupabase PostgreSQLデータベース設計を記述します。

### 1.1 設計方針
- Supabase Auth連携による認証・認可
- Row Level Security (RLS) によるデータ保護
- ユーザー毎のデータ分離
- リアルタイム同期対応（複数デバイス）
- スケーラブルな設計

### 1.2 技術スタック
- **データベース**: Supabase PostgreSQL
- **認証**: Supabase Auth (JWT ベース)
- **セキュリティ**: Row Level Security (RLS)
- **リージョン**: AWS ap-northeast-1

## 2. データモデル概要

### 2.1 ER図概要
```
Users (Supabase Auth連携)
   │
   ├─ Sessions (1:N) ─── Messages (1:N)
   │                         │
   └─ Bookmarks (1:N) ───────┘ (N:1)
```

### 2.2 テーブル一覧
1. **users** - ユーザー情報（Supabase Auth 連携）
2. **sessions** - チャットセッション管理
3. **messages** - 対話履歴（ユーザー・AI メッセージ）
4. **bookmarks** - ブックマーク（学習素材保存）

## 3. テーブル設計詳細

### 3.1 users テーブル
ユーザー基本情報とプリファレンス管理

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT auth.uid(),
  email TEXT UNIQUE,
  display_name TEXT,
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PRIMARY KEY | Supabase Auth UID |
| email | TEXT | UNIQUE | メールアドレス |
| display_name | TEXT | | 表示名 |
| preferences | JSONB | DEFAULT '{}' | ユーザー設定（TTS設定、学習レベル等） |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

**preferences フィールド構造例:**
```json
{
  "tts_voice": "alloy",
  "tts_speed": 1.0,
  "learning_level": "intermediate",
  "ui_language": "ja"
}
```

### 3.2 sessions テーブル
チャット履歴の管理単位

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PRIMARY KEY | セッション一意ID |
| user_id | UUID | FOREIGN KEY | ユーザーID |
| title | TEXT | | セッションタイトル（自動生成可） |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

### 3.3 messages テーブル
対話履歴（ユーザー・AI メッセージ）

```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES sessions(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role TEXT CHECK (role IN ('user', 'assistant')) NOT NULL,
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PRIMARY KEY | メッセージ一意ID |
| session_id | UUID | FOREIGN KEY | セッションID |
| user_id | UUID | FOREIGN KEY | ユーザーID |
| role | TEXT | CHECK制約 | 'user' または 'assistant' |
| content | TEXT | NOT NULL | メッセージ本文 |
| metadata | JSONB | DEFAULT '{}' | メタデータ（学習レベル、生成パラメータ等） |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |

**metadata フィールド構造例:**
```json
{
  "learning_level": "intermediate",
  "message_type": "learning_example",
  "topic": "business_meeting",
  "generated_count": 3,
  "ai_model": "gpt-4"
}
```

### 3.4 bookmarks テーブル
学習素材のブックマーク保存

```sql
CREATE TABLE bookmarks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id) ON DELETE SET NULL,
  text_en TEXT NOT NULL,
  text_ja TEXT,
  notes TEXT,
  audio_url TEXT,
  play_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_played_at TIMESTAMP WITH TIME ZONE
);
```

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PRIMARY KEY | ブックマーク一意ID |
| user_id | UUID | FOREIGN KEY | ユーザーID |
| message_id | UUID | FOREIGN KEY | 元メッセージID（削除時はNULL） |
| text_en | TEXT | NOT NULL | 英語文 |
| text_ja | TEXT | | 日本語訳 |
| notes | TEXT | | ユーザーメモ |
| audio_url | TEXT | | TTS音声URL（ElevenLabs/キャッシュ） |
| play_count | INTEGER | DEFAULT 0 | 再生回数 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| last_played_at | TIMESTAMP WITH TIME ZONE | | 最終再生日時 |

## 4. インデックス設計

### 4.1 パフォーマンス最適化インデックス

```sql
-- sessions テーブル
CREATE INDEX idx_sessions_user_id_created_at ON sessions(user_id, created_at DESC);

-- messages テーブル
CREATE INDEX idx_messages_session_id_created_at ON messages(session_id, created_at);
CREATE INDEX idx_messages_user_id ON messages(user_id);

-- bookmarks テーブル
CREATE INDEX idx_bookmarks_user_id_created_at ON bookmarks(user_id, created_at DESC);
CREATE INDEX idx_bookmarks_text_en ON bookmarks USING gin(to_tsvector('english', text_en));
CREATE INDEX idx_bookmarks_last_played_at ON bookmarks(user_id, last_played_at DESC NULLS LAST);
```

### 4.2 全文検索インデックス

```sql
-- ブックマーク検索用
CREATE INDEX idx_bookmarks_search ON bookmarks 
USING gin(to_tsvector('english', text_en || ' ' || COALESCE(text_ja, '') || ' ' || COALESCE(notes, '')));
```

## 5. 制約・トリガー設計

### 5.1 データ整合性制約

```sql
-- users テーブルの更新トリガー
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sessions_updated_at BEFORE UPDATE ON sessions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 5.2 バリデーション制約

```sql
-- email形式チェック
ALTER TABLE users ADD CONSTRAINT check_email_format 
CHECK (email ~* '^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+[.][A-Za-z]+$');

-- play_count の正数チェック
ALTER TABLE bookmarks ADD CONSTRAINT check_play_count_positive 
CHECK (play_count >= 0);

-- text_en の最小長チェック
ALTER TABLE bookmarks ADD CONSTRAINT check_text_en_length 
CHECK (length(trim(text_en)) >= 1);
```

## 6. Row Level Security (RLS) 設計

### 6.1 RLS 有効化

```sql
-- 全テーブルでRLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;
```

### 6.2 RLS ポリシー

```sql
-- Users: 自分のデータのみアクセス可能
CREATE POLICY "Users can access own data" ON users 
FOR ALL USING (auth.uid() = id);

-- Sessions: 自分のセッションのみアクセス可能
CREATE POLICY "Users can access own sessions" ON sessions 
FOR ALL USING (auth.uid() = user_id);

-- Messages: 自分のメッセージのみアクセス可能
CREATE POLICY "Users can access own messages" ON messages 
FOR ALL USING (auth.uid() = user_id);

-- Bookmarks: 自分のブックマークのみアクセス可能
CREATE POLICY "Users can access own bookmarks" ON bookmarks 
FOR ALL USING (auth.uid() = user_id);
```

### 6.3 サービスロール用ポリシー

```sql
-- サービスロール（管理・分析用）のポリシー
CREATE POLICY "Service role can access all data" ON users 
FOR ALL TO service_role USING (true);

CREATE POLICY "Service role can access all sessions" ON sessions 
FOR ALL TO service_role USING (true);

CREATE POLICY "Service role can access all messages" ON messages 
FOR ALL TO service_role USING (true);

CREATE POLICY "Service role can access all bookmarks" ON bookmarks 
FOR ALL TO service_role USING (true);
```

## 7. 関数・プロシージャ

### 7.1 ブックマーク統計関数

```sql
-- ユーザーのブックマーク統計を取得
CREATE OR REPLACE FUNCTION get_user_bookmark_stats(user_uuid UUID)
RETURNS TABLE(
    total_bookmarks BIGINT,
    total_plays BIGINT,
    most_played_text TEXT,
    recent_bookmark_count BIGINT
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(*) as total_bookmarks,
        SUM(play_count) as total_plays,
        (SELECT text_en FROM bookmarks 
         WHERE user_id = user_uuid 
         ORDER BY play_count DESC LIMIT 1) as most_played_text,
        COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '7 days') as recent_bookmark_count
    FROM bookmarks 
    WHERE user_id = user_uuid;
END;
$$;
```

### 7.2 セッション管理関数

```sql
-- 古いセッションのクリーンアップ
CREATE OR REPLACE FUNCTION cleanup_old_sessions()
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    -- 30日以上古いセッションを削除（カスケードでメッセージも削除）
    DELETE FROM sessions 
    WHERE created_at < NOW() - INTERVAL '30 days';
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$;
```

## 8. ビュー設計

### 8.1 ユーザーダッシュボード用ビュー

```sql
-- ユーザー学習統計ビュー
CREATE VIEW user_learning_stats AS
SELECT 
    u.id as user_id,
    u.display_name,
    COUNT(DISTINCT s.id) as total_sessions,
    COUNT(DISTINCT m.id) FILTER (WHERE m.role = 'user') as user_messages,
    COUNT(DISTINCT b.id) as total_bookmarks,
    SUM(b.play_count) as total_plays,
    MAX(s.created_at) as last_session_date,
    MAX(b.last_played_at) as last_play_date
FROM users u
LEFT JOIN sessions s ON u.id = s.user_id
LEFT JOIN messages m ON s.id = m.session_id
LEFT JOIN bookmarks b ON u.id = b.user_id
GROUP BY u.id, u.display_name;
```

### 8.2 人気コンテンツ分析ビュー

```sql
-- 人気ブックマークビュー（プライバシー保護）
CREATE VIEW popular_learning_content AS
SELECT 
    text_en,
    COUNT(*) as bookmark_count,
    AVG(play_count) as avg_play_count,
    MAX(created_at) as latest_bookmark_date
FROM bookmarks
GROUP BY text_en
HAVING COUNT(*) >= 3  -- 3人以上がブックマークした内容のみ
ORDER BY bookmark_count DESC, avg_play_count DESC;
```

## 9. バックアップ・復旧設計

### 9.1 バックアップ戦略
- **自動バックアップ**: Supabase標準機能（日次フルバックアップ）
- **Point-in-Time Recovery**: 7日間のWALログ保持
- **手動バックアップ**: 重要更新前の追加バックアップ

### 9.2 データ保持ポリシー
- **ユーザーデータ**: アカウント削除まで無期限保持
- **セッション履歴**: 30日間自動保持（関数による自動削除）
- **ブックマーク**: ユーザー削除まで永続保持
- **監査ログ**: 90日間保持（Supabaseログ機能）

## 10. 監視・メンテナンス

### 10.1 パフォーマンス監視
```sql
-- テーブルサイズ監視クエリ
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 10.2 定期メンテナンス
- **統計情報更新**: 週次 ANALYZE実行
- **インデックス再構築**: 月次 REINDEX（必要に応じて）
- **古データクリーンアップ**: 日次 cleanup_old_sessions() 実行

## 11. 拡張性・将来対応

### 11.1 スケーラビリティ対応
- **パーティショニング**: messages テーブルの月次パーティション化検討
- **読み取り専用レプリカ**: 分析クエリ用の別インスタンス検討
- **キャッシュ層**: Redis導入による頻繁アクセスデータキャッシュ

### 11.2 機能拡張対応
- **多言語対応**: languages テーブル追加
- **コースシステム**: courses, lessons テーブル追加
- **ソーシャル機能**: friends, shared_bookmarks テーブル追加

## 12. セキュリティ考慮事項

### 12.1 データ暗号化
- **保存時暗号化**: Supabase標準（AES-256）
- **転送時暗号化**: TLS 1.3 強制
- **機密データ**: API キー等は環境変数で管理

### 12.2 アクセス制御
- **最小権限の原則**: RLSによる厳格なデータ分離
- **監査ログ**: Supabase ログ機能による操作記録
- **レート制限**: API レベルでの制限実装

---

**作成日**: 2025年1月13日  
**バージョン**: 1.0  
**対象システム**: practice-english-chat  
**データベース**: Supabase PostgreSQL
